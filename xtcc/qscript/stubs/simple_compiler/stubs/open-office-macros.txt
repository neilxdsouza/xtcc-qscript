REM  *****  BASIC  *****
option explicit
Sub Main
	'Globalscope.BasicLibraries.LoadLibrary( "MRILib" )
	'oTarget = StarDesktop.getCurrentComponent().getCurrentSelection()
 	'Mri oTarget
	'HelloWorld2()
	'export_as_html
	export_tables_as_text
End Sub
 	
sub HelloWorld1

end sub
	
sub HelloWorld2
	print "hello world2"
end sub

sub export_as_html

Dim FileNo As Integer, Filename As String, CurLine As String
Dim Doc As Object   
Dim Enum1 As Object, Enum2 As Object
Dim TextElement As Object, TextPortion As Object
 
Filename = "/home/nxd/Downloads/openoffice-writer-doc-export-text-as-html-2.html"
FileNo = Freefile
Open Filename For Output As #FileNo   
Print #FileNo, "<HTML><BODY>"
Doc = ThisComponent
Enum1 = Doc.Text.createEnumeration
 
' loop over all paragraphs
While Enum1.hasMoreElements
  TextElement = Enum1.nextElement
 ' If TextElement.supportsService("com.sun.star.text.TextTable") Then
    'TablePortion = Enum2.nextElement
    
 '   myCurLine = "<P>is a table</p><p>"
  '  myCurLine = myCurLine & TextElement.String 
   ' Print #FileNo, myCurLine
    
  'end if
  If TextElement.supportsService("com.sun.star.text.Paragraph") Then
    Enum2 = TextElement.createEnumeration
    CurLine = "<P>"
 
    ' loop over all paragraph portions
    While Enum2.hasMoreElements
      TextPortion = Enum2.nextElement
 
      If TextPortion.CharWeight = com.sun.star.awt.FontWeight.BOLD THEN
        CurLine = CurLine & "<B>" & TextPortion.String & "</B>"
      Else
        CurLine = CurLine & TextPortion.String
      End If
 
    Wend
 
    ' output the line
    CurLine = CurLine & "</P>"
    Print #FileNo, CurLine
  End If
 
Wend
 
' write HTML footer 
Print #FileNo, "</BODY></HTML>"
Close #FileNo
end sub

	
sub visit_all_paragraphs

 	Dim Doc As Object
	Dim Enum As Object
	Dim TextElement As Object
 
	' Create document object   
	Doc = ThisComponent
	' Create enumeration object 
	Enum = Doc.Text.createEnumeration
	' loop over all text elements
 
	While Enum.hasMoreElements
	  TextElement = Enum.nextElement
 
	  If TextElement.supportsService("com.sun.star.text.TextTable") Then
    	MsgBox "The current block contains a table."
	  End If
 
	  If TextElement.supportsService("com.sun.star.text.Paragraph") Then
    	MsgBox "The current block contains a paragraph."
	  End If
 
	Wend
end sub	

sub export_tables_as_text

	Dim FileNo As Integer, Filename As String, CurLine As String
	Dim Doc As Object
	Dim TextTables As Object
	Dim Table As Object
	Dim CellNames
	Dim Cell As Object
	Dim CellCursor As Object
	Dim I As Integer
	Dim J As Integer
	Dim Rows As Object
	Dim Cols As Object
	Dim nRows As Integer
	Dim nCols As Integer

	
	'Print #FileNo, "<HTML><BODY>"
	
	Filename = "/home/nxd/Downloads/openoffice-writer-doc-export-text-as-html-3.html"
	FileNo = Freefile
	Open Filename For Output As #FileNo   
	Print #FileNo, "<HTML><BODY>"
	
	 
	Doc = ThisComponent
	TextTables = Doc.getTextTables()
	 
	For I = 0 to TextTables.count - 1
	
		Table = TextTables(I)
	   	Rows = Table.getRows()
		Cols = Table.getColumns()
		nRows = Rows.getCount()
		nCols = Cols.getCount()
		CellNames = Table.getCellNames()
		Print #FileNo, "nRows: ", nRows, "Columns: ", nCols
	 
		For J = 0 to UBound(CellNames)
			Cell = Table.getCellByName(CellNames(J))
			Print #FileNo, CellNames(J), ":", Cell.String
	      'If IsNumeric(Cell.String) Then
	      '   CellCursor = Cell.createTextCursor()
	      '   CellCursor.paraAdjust = com.sun.star.style.ParagraphAdjust.RIGHT
	      'End If
		Next
	Next

end sub

sub export_tables_as_text2

	Dim FileNo As Integer, Filename As String, CurLine As String
	Dim Doc As Object
	Dim TextTables As Object
	Dim Table As Object
	Dim CellNames
	Dim Cell As Object
	Dim CellCursor As Object
	Dim I As Integer
	Dim J As Integer
	Dim Rows As Object
	Dim Cols As Object
	Dim nRows As Integer
	Dim nCols As Integer
	Dim rowi As Integer, coli As Integer
	Dim CellName_EnglishStub as String, CellName_NumericCode as String
	Dim Cell_EnglishStub as Object,	Cell_NumericCode as Object
	'Dim Cell as Object
		
	
	'Print #FileNo, "<HTML><BODY>"
	
	Filename = "/home/nxd/Downloads/openoffice-writer-doc-export-text-as-html-3.html"
	FileNo = Freefile
	Open Filename For Output As #FileNo   
	Print #FileNo, "<HTML><BODY>"
	
	 
	Doc = ThisComponent
	TextTables = Doc.getTextTables()
	 
	For I = 0 to TextTables.count - 1
	
		Table = TextTables(I)
	   	Rows = Table.getRows()
		Cols = Table.getColumns()
		nRows = Rows.getCount()
		nCols = Cols.getCount()
		CellNames = Table.getCellNames()
		Print #FileNo, "nRows: ", nRows, "Columns: ", nCols
	 	if nCols = 3 then
	 		for rowi = 1 to nRows
	 			'for coli = 1 to nCols - 1 'arabic text is in col C					
	 				coli = 1
					CellName_EnglishStub = Chr(Asc("A") - 1 + coli) & rowi
					Cell_EnglishStub = Table.getCellByName(CellName_EnglishStub)
					coli = 2
					CellName_NumericCode = Chr(Asc("A") - 1 + coli) & rowi
					Cell_NumericCode = Table.getCellByName(CellName_NumericCode)
					
					Print #FileNo, "'",Cell_EnglishStub.String, "'", Cell_NumericCode.String
				'next
			next
			'Cell = Table.getCellByName(CellName)
	 	
	 	end if
	 	
		
	Next

end sub

sub export_text_and_tables

	Dim FileNo As Integer, Filename As String, CurLine As String
	Dim Doc As Object
	Dim Enum1 As Object, Enum2 As Object
	Dim TextElement As Object, TextPortion As Object, Table As Object
	
	Filename = "/home/nxd/Downloads/raw_dump.qscript"
	FileNo = Freefile
	Open Filename For Output As #FileNo
	
	MsgBox(FileNo,16,"error")
	
	Doc = ThisComponent
	Enum1 = Doc.Text.createEnumeration
	While Enum1.hasMoreElements
		TextElement = Enum1.nextElement
		If TextElement.supportsService("com.sun.star.text.TextTable") Then
			Table = TextElement
			print_stubs (Table, FileNo)
			#If False Then


		   	Rows = Table.getRows()
			Cols = Table.getColumns()
			nRows = Rows.getCount()
			nCols = Cols.getCount()
			'CellNames = Table.getCellNames()
			Print #FileNo, "nRows: ", nRows, "Columns: ", nCols
	 		if nCols = 3 then
	 			for rowi = 1 to nRows
	 			'for coli = 1 to nCols - 1 'arabic text is in col C					
	 				coli = 1
					CellName_EnglishStub = Chr(Asc("A") - 1 + coli) & rowi
					Cell_EnglishStub = Table.getCellByName(CellName_EnglishStub)
					coli = 2
					CellName_NumericCode = Chr(Asc("A") - 1 + coli) & rowi
					Cell_NumericCode = Table.getCellByName(CellName_NumericCode)
					CurLine = Cell_EnglishStub.String
					CurLine  = RTrim(CurLine)
					CurLine  = LTrim(CurLine)
					Print #FileNo, Chr(34),CurLine, Chr(34), Cell_NumericCode.String

				next
		 	end if				
			if nCols = 5 then
	 			for rowi = 1 to nRows
	 			'for coli = 1 to nCols - 1 'arabic text is in col C					
	 				coli = 4
					CellName_EnglishStub = Chr(Asc("A") - 1 + coli) & rowi
					Cell_EnglishStub = Table.getCellByName(CellName_EnglishStub)
					coli = 3
					CellName_NumericCode = Chr(Asc("A") - 1 + coli) & rowi
					Cell_NumericCode = Table.getCellByName(CellName_NumericCode)
					CurLine = Cell_EnglishStub.String
					CurLine  = RTrim(CurLine)
					CurLine  = LTrim(CurLine)
					Print #FileNo, Chr(34),CurLine, Chr(34), Cell_NumericCode.String

				next		
			end if
			#End If
		end if	
	
		If TextElement.supportsService("com.sun.star.text.Paragraph") Then
    		Enum2 = TextElement.createEnumeration
    		CurLine = Chr(34)
 
		    ' loop over all paragraph portions
		    While Enum2.hasMoreElements
				TextPortion = Enum2.nextElement
 
				'If TextPortion.CharWeight = com.sun.star.awt.FontWeight.BOLD THEN
				'	CurLine = CurLine & "<B>" & TextPortion.String & "</B>"
				'Else
				'	CurLine = CurLine & TextPortion.String
				'End If
				CurLine = CurLine & TextPortion.String
 
			Wend
 
			' output the line
			CurLine = CurLine & Chr(34) & Chr(10) &" sp int32_t (1-100);" & Chr(10)
			
			Print #FileNo, CurLine
		End If
	wend
end sub


sub export_text_and_tables2

	Dim FileNo As Integer, Filename As String, CurLine As String
	Dim Doc As Object
	Dim Enum1 As Object, Enum2 As Object
	Dim TextElement As Object, TextPortion As Object, Table As Object
	Dim temp_str as string, temp_str2 as string
	
	Filename = "/home/nxd/Downloads/raw_dump.qscript"
	FileNo = Freefile
	Open Filename For Output As #FileNo
	
	'MsgBox(FileNo,16,"error")
	
	Doc = ThisComponent
	Enum1 = Doc.Text.createEnumeration
	While Enum1.hasMoreElements
		TextElement = Enum1.nextElement
		If TextElement.supportsService("com.sun.star.text.TextTable") Then
			Print #FileNo; "// Got a Table"		
			Table = TextElement
			print_stubs (Table, FileNo)
		end if	
	
		If TextElement.supportsService("com.sun.star.text.Paragraph") Then
    		Enum2 = TextElement.createEnumeration
    		'CurLine = Chr(34)
 			Curline = ""
		    ' loop over all paragraph portions		    
		    'TextPortion = Enum2.nextElement
		    While Enum2.hasMoreElements
		    	TextPortion = Enum2.nextElement
				
 
				'If TextPortion.CharWeight = com.sun.star.awt.FontWeight.BOLD THEN
				'	CurLine = CurLine & "<B>" & TextPortion.String & "</B>"
				'Else
				'	CurLine = CurLine & TextPortion.String
				'End If
				
				if (len(TextPortion.string)>0) then
					temp_str = RTrim(LTrim(TextPortion.String))
					temp_str2 = mid(temp_str, 1, 10)
					if StrComp (temp_str2, "----------") = 0 then
					else
						CurLine = CurLine & " " & RTrim(LTrim(TextPortion.String))
					endif
				end if
 				'TextPortion = Enum2.nextElement
			Wend
 
			' output the line
			CurLine = RTrim(LTrim(CurLine ))
			if (len(CurLine)>0) then			
				CurLine = Chr(34) & CurLine & Chr(34) & Chr(10) &" sp int32_t (1-100);" & Chr(10)
				Print #FileNo, CurLine
			end if						
		End If
	wend
end sub

sub determine_first_row_that_has_numeric_code(table as Object, _ 
			the_cell_name as string, the_cell_data as string, _
			start_row As Integer, start_col_name as String, _
			codes_incr_vert As Integer, codes_incr_horz As Integer)
	Dim Cols as Object, Rows as Object	
	Dim nRows As Integer
	Dim nCols As Integer
	Dim found As Integer
	Dim the_cell As Object
	Dim CellNames As Object
	Dim i as Integer
	Dim cell as Object, a_cell as Object
	Dim prev_cell_val as Integer, curr_cell_val as Integer
	Dim cell_name as String
	Dim start_col_no as Integer
	'Dim the_cell as object
	'Dim start_row As Integer
	'Dim codes_incr_vert As Integer ' 1 = incr as u go down,  2 = decr as you go down
									' 0 = no, 4 = not determined
	'Dim codes_incr_horz As Integer ' 1 = incr as u go right, 2=decr as you go right
									' 0 = no, 4 = not determined
	' set to indeterminate
	codes_incr_vert = 4
	codes_incr_horz = 4
	
	found = 0
	
	CellNames = Table.getCellNames()
	Rows = Table.getRows()
	Cols = Table.getColumns()
	nRows = Rows.getCount()
	nCols = Cols.getCount()
	
	'for rowi = 1 to nRows
	'	CellNames = Rows(i).getCellNames()
	'	for coli = 1 to  UBound(CellNames)		
	'		If IsNumeric(Cell.String) Then
	'			i_th_row = rowi
	'			Exit For
	'		end if
	'	next
	'next
	for i = 0 to UBound(CellNames)
		cell = Table.getCellByName(CellNames(i))
		if IsNumeric (cell.String) then
			the_cell_name = CellNames(i)
			the_cell = cell
			the_cell_data = the_cell.string
			found = 1
			'msgbox (the_cell_name)
			exit for
		end if
	next
	if found = 1 then
		start_row = val(right (the_cell_name, 1))
		start_col_name = left (the_cell_name, 1)
		prev_cell_val = val (the_cell.string)
		
		for i = start_row + 1 to nRows
			cell_name = start_col_name & i
			a_cell = Table.getCellByName(cell_name)
			if IsNumeric (a_cell.String) then
				curr_cell_val = val (a_cell.string)
				if (curr_cell_val > prev_cell_val) then
					codes_incr_vert = 1
					exit for
				elseif (curr_cell_val < prev_cell_val) then
					codes_incr_vert = 2 
					exit for
				else 
					codes_incr_vert = 0
					exit for
				end if
			end if
		next
		' search for more codes in the same column
		'CellName_EnglishStub = Chr(Asc("A") - 1 + coli) & rowi
		'for i = start_row + 1 to nRows
		
		start_col_no = Asc(start_col_name) - Asc("A") + 1
		for i = start_col_no + 1 to nCols
			cell_name = Chr (Asc ("A") - 1 + i) & start_row
			a_cell = Table.getCellByName(cell_name)
			'if the_cell_data = the_cell.string
			if IsNumeric (a_cell.String) then
				curr_cell_val = val (a_cell.string)
				if (curr_cell_val > prev_cell_val) then
					codes_incr_horz = 1
					exit for
				elseif (curr_cell_val < prev_cell_val) then
					codes_incr_horz = 2 
					exit for
				else 
					codes_incr_horz = 0
					exit for
				end if
			end if 
		next
		
	end if

end sub


sub print_stubs (table as Object, FileNo as Integer)
	Dim CurLine As String
	Dim Cols as Object, Rows as Object	
	Dim nRows As Integer
	Dim nCols As Integer
	Dim the_cell_has_numeric_data As String, the_cell_data As String
	'Dim start_row As Integer	
	Dim start_row As Integer, start_col_name as String, _
		codes_incr_vert As Integer, codes_incr_horz As Integer
	Dim rowi as Integer, coli as Integer
	Dim CellName_EnglishStub as string, CellName_NumericCode  as string
	Dim Cell_NumericCode as object, Cell_EnglishStub as object
	
	'If IsNumeric(Cell.String) Then
	Rows = Table.getRows()
	Cols = Table.getColumns()
	nRows = Rows.getCount()
	nCols = Cols.getCount()
	
	determine_first_row_that_has_numeric_code (table,the_cell_has_numeric_data, the_cell_data, start_row, start_col_name, codes_incr_vert, codes_incr_horz)
	'start_row = val (right (the_cell_has_numeric_data, 1))
	'CellNames = Table.getCellNames()
	Print #FileNo, "// nRows: "; nRows; ", Columns: "; nCols; _
			", i_th_row_has_numeric_data: "; the_cell_has_numeric_data; ", the_data_is: "; the_cell_data; _
		", start_row: "; start_row; ", codes_incr_vert: "; codes_incr_vert; ", codes_incr_horz: "; codes_incr_horz
	if codes_incr_horz = 4 and nCols = 3 and (codes_incr_vert = 1 or codes_incr_vert = 2) then
		Print #FileNo, "stubs s1="	
		for rowi = start_row to nRows
			'for coli = 1 to nCols - 1 'arabic text is in col C					
			coli = 1
			CellName_EnglishStub = Chr(Asc("A") - 1 + coli) & rowi
			Cell_EnglishStub = Table.getCellByName(CellName_EnglishStub)
			coli = 2
			CellName_NumericCode = Chr(Asc("A") - 1 + coli) & rowi
			Cell_NumericCode = Table.getCellByName(CellName_NumericCode)
			CurLine = RTrim(LTrim (Cell_EnglishStub.String))
			'CurLine  = RTrim(CurLine)
			'CurLine  = LTrim(CurLine)
			Print #FileNo, Chr(34); CurLine; Chr(34), Cell_NumericCode.String
		next
		Print #FileNo, ";"
	elseif codes_incr_horz = 4 and  nCols = 5 and (codes_incr_vert = 1 or codes_incr_vert = 2) then 	'if nCols = 5 and start_row = 1 then
		Print #FileNo, "stubs s1="		
		for rowi = start_row to nRows
			'for coli = 1 to nCols - 1 'arabic text is in col C					
			coli = 4
			CellName_EnglishStub = Chr(Asc("A") - 1 + coli) & rowi
			Cell_EnglishStub = Table.getCellByName(CellName_EnglishStub)
			coli = 3
			CellName_NumericCode = Chr(Asc("A") - 1 + coli) & rowi
			Cell_NumericCode = Table.getCellByName(CellName_NumericCode)
			CurLine = RTrim(LTrim (Cell_EnglishStub.String))
			'CurLine = Cell_EnglishStub.String
			'CurLine  = RTrim(CurLine)
			'CurLine  = LTrim(CurLine)
			Print #FileNo, Chr(34); CurLine; Chr(34), Cell_NumericCode.String
		next
		Print #FileNo, ";"
	elseif codes_incr_horz = 0 then
		Print #FileNo, "stubs s1="		
		for rowi = start_row to nRows
			'for coli = 1 to nCols - 1 'arabic text is in col C					
			coli = 1
			CellName_EnglishStub = Chr(Asc("A") - 1 + coli) & rowi
			Cell_EnglishStub = Table.getCellByName(CellName_EnglishStub)
			coli = 2
			CellName_NumericCode = Chr(Asc("A") - 1 + coli) & rowi
			Cell_NumericCode = Table.getCellByName(CellName_NumericCode)
			CurLine = RTrim(LTrim (Cell_EnglishStub.String))
			'CurLine = Cell_EnglishStub.String
			'CurLine  = RTrim(CurLine)
			'CurLine  = LTrim(CurLine)
			Print #FileNo, Chr(34); CurLine; Chr(34), Cell_NumericCode.String
		next
		Print #FileNo, ";"
	elseif (nCols <> 3 and nCols <>5) and start_row >= 1 and (codes_incr_vert = 1 or codes_incr_vert = 2) then
		Print #FileNo, "stubs s1="		
		for rowi = start_row to nRows
			'for coli = 1 to nCols - 1 'arabic text is in col C		
			coli = 1
			CellName_EnglishStub = Chr (Asc("A") - 1 + coli) & rowi
			Cell_EnglishStub = Table.getCellByName(CellName_EnglishStub)
			coli = 2
			CellName_NumericCode = Chr (Asc("A") - 1 + coli) & rowi
			Cell_NumericCode = Table.getCellByName (CellName_NumericCode)
			CurLine = Cell_EnglishStub.String
			CurLine  = RTrim (CurLine)
			CurLine  = LTrim (CurLine)
			Print #FileNo, Chr (34); CurLine; Chr (34), Cell_NumericCode.String
		next
		Print #FileNo, ";"		
	elseif (codes_incr_horz <> 4 and codes_incr_horz <> 0) and (codes_incr_vert = 0) then '(nCols <> 3 and nCols <>5) and start_row >= 1 and (codes_incr_vert = 0)
		Print #FileNo, "named_attribute n1 = "
		for rowi = start_row to nRows
			'for coli = 1 to nCols - 1 'arabic text is in col C		
			coli = 1
			CellName_EnglishStub = Chr (Asc("A") - 1 + coli) & rowi
			Cell_EnglishStub = Table.getCellByName(CellName_EnglishStub)
			coli = 2
			CellName_NumericCode = Chr (Asc("A") - 1 + coli) & rowi
			Cell_NumericCode = Table.getCellByName (CellName_NumericCode)
			CurLine = Cell_EnglishStub.String
			CurLine  = RTrim (CurLine)
			CurLine  = LTrim (CurLine)
			Print #FileNo, Chr (34); CurLine; Chr (34), ","
		next
		Print #FileNo, ";"		
	end if
end sub
